name: Fuzzer execution

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Every day at 7pm PST/4am CET
  pull_request:

jobs:
  fuzzer-execution:
    name: Fuzzer execution matrix
    uses: ./.github/workflows/fuzzing-run.yml
    strategy:
      fail-fast: false
      matrix:
        target:
          [
            { os: ubuntu, version: 22.04, package-type: DEB, container-tag: '@sha256:0eed71cef37604c37186ec035974168a40a84d27e26d3b746a2858d99f305e2e' },
          ]
        arch: [amd64]
    with:
      target: ${{ matrix.target.os }}-${{ matrix.target.version }}
      arch: ${{ matrix.arch }}
      package-type: ${{ matrix.target.package-type }}
      timeout-seconds: 3600
      execute: ${{ contains(fromJSON('["workflow_dispatch", "schedule"]'), github.event_name) }}
      container-tag: ${{ matrix.target.container-tag }}

  # Needed for required checks to aggregate the results of all fuzzer executions
  fuzzer-status:
    runs-on: ubuntu-latest
    needs: [fuzzer-execution]
    if: always()
    steps:
      - run: ${{!contains(needs.*.result, 'failure')}}
