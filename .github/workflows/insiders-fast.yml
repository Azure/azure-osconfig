name: Publish (insiders-fast)

on:
  schedule:
    - cron: "0 8 * * *"  # Every day at 8:00 am UTC

jobs:
  changes:
    name: Check changes
    runs-on: ubuntu-latest
    outputs:
      new: ${{ steps.commits.outputs.new }}
    steps:
      - name: Check last commit
        id: commits
        run: |
          date=$(gh api graphql -F owner='Azure' -F name='azure-osconfig' -f query='
            query($name: String!, $owner: String!) {
              repository(name: $name, owner: $owner) {
                defaultBranchRef {
                  target {
                    ... on Commit {
                      pushedDate
                    }
                  }
                }
              }
            }' | jq .data.repository.defaultBranchRef.target.pushedDate | sed 's/"//g')

          # Only publish a new package if changes have been made since the last package was published

          cutoff=$(date -d '1 day ago' +%s)
          age=$(date -d "$date" +%s)

          if (($age > $cutoff))
          then
            echo new=true >> $GITHUB_OUTPUT
          else
            echo ::warning title="No changes since last nightly package" "Last change was committed on $date. Skipping nightly package."
            echo new=false >> $GITHUB_OUTPUT
          fi

  publish:
    name: Publish
    needs: changes
    if: ${{ needs.changes.outputs.new == 'true' }}
    uses: ./.github/workflows/publish.yml
    strategy:
      matrix:
        os: [ubuntu-18.04, ubuntu-20.04, debian-10, debian-11]
    with:
      os: ${{ matrix.os }}
      channel: insiders-fast
    secrets: inherit
