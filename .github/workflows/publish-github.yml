name: Publish

on:
  workflow_call:
    inputs:
      target:
        type: string
        required: true
      arch:
        type: string
        required: true
      dist:
        type: string
        required: true
      package-type:
        type: string
        required: true
      environment:
        type: string
        description: The GitHub environment to use for the build.
        required: true
      release-name:
        type: string
        description: The GitHub release name to update.
        required: true
      container-tag:
        type: string
        required: false
        default: latest
      buildForMachineConfiguration:
        type: boolean
        required: false
        default: false

jobs:
  package:
    uses: ./.github/workflows/package-build.yml
    with:
      target: ${{ inputs.target }}
      arch: ${{ inputs.arch }}
      artifact: ${{ inputs.target }}-${{ inputs.arch }}
      package-type: ${{ inputs.package-type }}
      container-tag: ${{ inputs.container-tag }}
      buildForMachineConfiguration: ${{ inputs.buildForMachineConfiguration }}
      release: true

  sign:
    uses: ./.github/workflows/package-sign.yml
    needs: package
    with:
      artifact: ${{ inputs.target }}-${{ inputs.arch }}
      key-code: ${{ inputs.dist == 'azurelinux' && 'CP-459159-Pgp' || 'CP-450779-Pgp' }}
      package-type: ${{ inputs.package-type }}
    secrets: inherit
