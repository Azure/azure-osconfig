name: CI

on:
  push:
    # paths:
    #   - "src/"
  workflow_dispatch:

jobs:
  unit-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [ubuntu18.04]
        arch: [amd64]
        # os: [ubuntu18.04, ubuntu20.04, debian9]
        # arch: [arm, arm64, amd64]

    container:
      image: osconfig.azurecr.io/${{ matrix.os }}-dev-${{ matrix.arch }}:latest
      options: --privileged
      credentials:
        username: ${{ secrets.ACR_CLIENT_ID }}
        password: ${{ secrets.ACR_CLIENT_SECRET }}

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
          clean: true
      
      - uses: docker/setup-qemu-action@v1
        # TODO: only if container is ARM
        with: 
          platforms: ${{ matrix.arch }}

      - name: Build azure-osconfig
        uses: ./.github/actions/build
        with: 
          build-type: Release
          source-directory: src
          build-directory: build

      - name: Set test output
        run: echo '::set-output name=file-name::${{ matrix.os }}-${{ matrix.arch }}-tests.xml'
        id: test-output

      - name: Run Unit Tests
        working-directory: ${{ github.workspace }}/build
        run: ctest --verbose --output-junit ${{ steps.test-output.outputs.file-name }}

      - uses: actions/upload-artifact@v2
        if: always()
        with:
          name: unit-test-results
          path: ${{ github.workspace }}/${{ env.build_directory }}/${{ steps.test-output.outputs.file-name }}