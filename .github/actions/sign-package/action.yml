name: Sign Package
description: Signs package artifacts using ESRP

inputs:
  artifact:
    description: The artifact containing packages to sign
    required: true
  package-type:
    description: The type of package to sign (deb | rpm)
    required: true

runs:
  using: composite
  steps:
    - uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact }}
        path: unsigned

    - name: Sign
      shell: python
      run: |
        import json
        import os
        import glob
        import pprint
        import subprocess
        import sys
        import re

        esrp_tool = 'EsrpClient'

        aad_id = os.environ['AAD_ID'].strip()
        esrp_id = os.environ['ESRP_ID'].strip()
        workspace = os.environ['GITHUB_WORKSPACE'].strip()
        keycode = os.environ['LINUX_KEY_CODE'].strip()
        opcode = os.environ['LINUX_OP_CODE'].strip()
        vault_name = os.environ.get('AZURE_VAULT', '').strip()
        request_auth_cert = os.environ.get('REQUEST_SIGNING_CERT', '').strip()
        msi_client_id = os.environ.get('MSI_CLIENT_ID', '').strip()

        source_location = 'unsigned'
        package_filter = '*.${{ inputs.package-type }}'
        files = glob.glob(os.path.join(source_location, package_filter.lower()))

        print("Found files:")
        pprint.pp(files)

        auth_json = {
          "AuthenticationType": "AAD_MSI",
          "ClientId": f"{aad_id}",
          "EsrpClientId": f"{esrp_id}",
          "RequestSigningCert": {
            "GetCertFromKeyVault": True,
            "KeyVaultName": f"{vault_name}",
            "KeyVaultCertName": f"{request_auth_cert}",
            "StoreLocation": "CurrentUser",
            "StoreName": "My",
            "SubjectName": f"CN={aad_id}",
            "SendX5c": False,
            "WithAzureRegion": False
          },
          "Version": "1.0.0"
        }

        input_json = {
          "Version": "1.0.0",
          "SignBatches": [
            {
              "SourceLocationType": "UNC",
              "SourceRootDirectory": source_location,
              "DestinationLocationType": "UNC",
              "DestinationRootDirectory": workspace,
              "SignRequestFiles": [],
              "SigningInfo": {
                "Operations": [
                  {
                    "KeyCode": f"{keycode}",
                    "OperationCode": f"{opcode}",
                    "Parameters": {},
                    "ToolName": "sign",
                    "ToolVersion": "1.0",
                  }
                ]
              }
            }
          ]
        }

        # add files to sign
        for f in files:
          name = os.path.basename(f)
          input_json["SignBatches"][0]["SignRequestFiles"].append(
            {
              "SourceLocation": name,
              "DestinationLocation": os.path.join("signed", name),
            }
          )

        policy_json = {
          "Version": "1.0.0",
          "Intent": "production release",
          "ContentType": "binary",
        }

        configs = [
          ("auth.json", auth_json),
          ("input.json", input_json),
          ("policy.json", policy_json),
        ]

        for filename, data in configs:
          with open(filename, 'w') as fp:
            json.dump(data, fp)

        # Run ESRP Client
        esrp_out = "esrp_out.json"
        result = subprocess.run(
          [esrp_tool, "sign",
          "-a", "auth.json",
          "-i", "input.json",
          "-p", "policy.json",
          "-o", esrp_out,
          "-l", "Verbose"],
          capture_output=True,
          text=True,
          cwd=workspace)

        # Scrub log before printing
        log = re.sub(r'^.+Uploading.*to\s*destinationUrl\s*(.+?),.+$',
            '***',
            result.stdout,
            flags=re.IGNORECASE|re.MULTILINE)

        print(log)

        if result.returncode != 0:
          print("Failed to run ESRPClient.exe")
          sys.exit(1)

        if os.path.isfile(esrp_out):
          print("ESRP output json:")
          with open(esrp_out, 'r') as fp:
            pprint.pp(json.load(fp))

        for file in files:
          if os.path.isfile(os.path.join("signed", file)):
            print(f"Success!\nSigned {file}")

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact }}-signed
        path: signed
